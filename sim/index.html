<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Christmas Card 2021 Simulator</title>

    <style>
        #canvas {
            display: block;
            margin: auto;
            border: solid 1px lightgray;
        }
    </style>
</head>
<body>

<canvas id="canvas"></canvas>

<script type="application/javascript">

    class Point {

        constructor(x, y) {
            this.x = x;
            this.y = y;
        }

        add(other) {
            return new Point(this.x + other.x, this.y + other.y);
        }

        sub(other) {
            return new Point(this.x - other.x, this.y - other.y);
        }

        distSquared(other) {
            return Math.pow(this.x - other.x, 2) + Math.pow(this.y - other.y, 2);
        }

    }

    class Frame {

        constructor() {
            this._leds = [];
            for (let i = 0; i < 54; i++) {
                this._leds.push(false);
            }
        }

        toggle(index) {
            this._leds[index - 1] = !this._leds[index - 1]
        }

        isOn(index) {
            return this._leds[index - 1];
        }

    }

    const canvas = document.querySelector("#canvas");
    const ctx = canvas.getContext("2d");
    canvas.width = 800;
    canvas.height = 800;
    canvas.style.width = "400px";
    canvas.style.height = "400px";
    ctx.scale(8, 8);
    ctx.lineWidth = 0.1;
    ctx.font = "2px Arial";
    ctx.fillStyle = "gray";

    const ledPositions = {};
    let currentFrame = new Frame();

    function radToDeg(a) {
        return a / Math.PI * 180;
    }

    function anglePoints(a, b) {
        return Math.atan((a.y - b.y) / (b.x - a.x));
    }

    function pointOnCircle(center, radius, angle) {
        const dx = Math.sin(angle) * radius;
        const dy = Math.cos(angle) * radius;
        return center.add(new Point(dx, dy));
    }

    function drawLED(ctx, point, index) {

        // Draw the LED
        ctx.beginPath();
        ctx.arc(point.x, point.y, 1, 0, 2 * Math.PI);
        ctx.stroke();
        if (currentFrame.isOn(index)) {
            ctx.fill();
        }
        ctx.fillText(`D${index}`, point.x + 1.5, point.y);
        // ctx.fillText(`(${ point.x.toFixed(1) }, ${ (100 - point.y).toFixed(1) })`, point.x + 1, point.y);

        // Add the LED to the point map
        ledPositions[index] = point;
    }

    function getMouse(e) {
        let element = canvas, offsetX = 0, offsetY = 0;

        // Compute the total offset
        if (element.offsetParent !== undefined) {
            do {
                offsetX += element.offsetLeft;
                offsetY += element.offsetTop;
            } while ((element = element.offsetParent));
        }

         return new Point((e.pageX - offsetX) / 4, (e.pageY - offsetY) / 4);
    }

    const center = new Point(50, 50);

    function draw() {

        ctx.clearRect(0, 0, canvas.width, canvas.height);

        const indexOrder = [
            27, 23, 10, 5, 46, 37,
            28, 24, 11, 4, 47, 38,
            30, 25, 12, 3, 48, 39,
            33, 13, 17, 2, 51, 42,
            34, 14, 18, 1, 52, 43,
            35, 31, 20, 26, 19, 15, 8, 6, 53, 49, 44, 40,
            36, 32, 21, 29, 22, 16, 9, 7, 54, 50, 45, 41,
        ];

        for (let radius = 9; radius <= 50; radius += 9) {
            for (let i = 0; i < 6; i++) {
                const angle = 2 * i * Math.PI / 6;
                const point = pointOnCircle(center, radius, angle);
                drawLED(ctx, point, indexOrder.shift());
            }
        }

        const radius1 = 35;
        const radius2 = 42;

        for (let i = 0; i < 6; i++) {
            const angle = 2 * i * Math.PI / 6;
            const point1 = pointOnCircle(center, radius1, angle - 0.2);
            const point2 = pointOnCircle(center, radius1, angle + 0.2);
            drawLED(ctx, point1, indexOrder.shift());
            drawLED(ctx, point2, indexOrder.shift());
            // const point3 = pointOnCircle(center, radius2, angle - 0.35);
            // const point4 = pointOnCircle(center, radius2, angle + 0.35);
            // ctx.fillText(`(${ radToDeg(anglePoints(point1, point3)).toFixed(1) })`, point3.x + 1, point3.y);
            // ctx.fillText(`(${ radToDeg(anglePoints(point2, point4)).toFixed(1) })`, point4.x + 1, point4.y);
        }

        for (let i = 0; i < 6; i++) {
            const angle = 2 * i * Math.PI / 6;
            const point1 = pointOnCircle(center, radius2, angle - 0.35);
            const point2 = pointOnCircle(center, radius2, angle + 0.35);
            drawLED(ctx, point1, indexOrder.shift());
            drawLED(ctx, point2, indexOrder.shift());
        }

    }

    // Fixes a problem where double clicking causes text to get selected on the canvas
    canvas.addEventListener('selectstart', function(e) { e.preventDefault(); return false; }, false);

    canvas.addEventListener('mouseup', function(e) {

        // Get mouse position
        let mouse = getMouse(e);

        // Toggle all LEDs within range of the mouse
        for (const [index, point] of Object.entries(ledPositions)) {
            if (Math.pow(point.x - mouse.x, 2) + Math.pow(point.y - mouse.y, 2) < 16) {
                currentFrame.toggle(index);
            }
        }

        // Redraw the canvas
        draw();

    }, true);

    draw();

</script>

</body>
</html>